var globCount = 1;
var isNav = false;
var Count = 1;
$(document).ready(function () {
	$(this).bind("contextmenu", function (e) {
	    e.preventDefault();
	});
	$("#exam-ddlQStatus").change(function () {
		var a = $("#exam-ddlQStatus option:selected").attr("value");
		FilterPaletteButtons(a);
	});
});

function show_modal(target) {
	waitingDialog.show();
	target = target;
	$('#targetModal').load(target, function () {
		$('#targetModal').modal('show');
		waitingDialog.hide();
	});
}

function checkAnswer(quesNo) {
	var quesType = $('#questype' + quesNo).text();
	if (quesType == "M") {
		if ($('form[name=post_req-' + quesNo + '] input[name="data[Exam][option_selected]"]').is(":checked") || $('form[name=post_req-' + quesNo + '] input[name="data[Exam][option_selected][]"]').is(":checked")) {
			return true;
		}
		else {
			return false;
		}
	}
	else if (quesType == "T") {
		if ($('form[name=post_req-' + quesNo + '] input[name="data[Exam][true_false]"]').is(":checked")) {
			return true;
		}
		else {
			return false;
		}
	}
	else if (quesType == "F") {
		if ($('form[name=post_req-' + quesNo + '] input[name="data[Exam][fill_blank]"]').val().length > 0) {
			return true;
		}
		else {
			return false;
		}
	}
	else if (quesType == "S") {
		if ($('form[name=post_req-' + quesNo + '] textarea[name="data[Exam][answer]"]').val().length > 0) {
			return true;
		}
		else {
			return false;
		}
	}
	else {
		return false;
	}
}

function resetAnswer(quesNo) {
	var quesType = $('#questype' + quesNo).text();
	if (quesType == "M") {
		$('form[name=post_req-' + quesNo + '] input[name="data[Exam][option_selected]"]').prop('checked', false);
		$('form[name=post_req-' + quesNo + '] input[name="data[Exam][option_selected][]"]').prop('checked', false);
	}
	else if (quesType == "T") {
		$('form[name=post_req-' + quesNo + '] input[name="data[Exam][true_false]"]').prop('checked', false);
	}
	else if (quesType == "F") {
		$('form[name=post_req-' + quesNo + '] input[name="data[Exam][fill_blank]"]').val('');
	}
	else if (quesType == "S") {
		$('form[name=post_req-' + quesNo + '] textarea[name="data[Exam][answer]"]').text('');
		$('form[name=post_req-' + quesNo + '] textarea[name="data[Exam][answer]"]').val('');
	}
	ChangeClassOFPaletteButton("notans", quesNo);
	getExamCounter();
	resetAnswerServer(quesNo);
}

function setPaletteColor(globCount, buttonState) {
	buttonState = buttonState || 0;
	var className = $('#navbtn' + globCount).attr('class');
	if (checkAnswer(globCount) && className == "exam-ButtonNotAnsweredMarked") {
		if (buttonState == 1) {
			ChangeClassOFPaletteButton("ans", globCount);
		}
		else {
			ChangeClassOFPaletteButton("ansmarked", globCount);
		}
	}
	else if (checkAnswer(globCount) && className != "exam-ButtonAnsweredMarked") {
		ChangeClassOFPaletteButton("ans", globCount);
	}
	else if (className != "exam-ButtonNotAnsweredMarked" && className != "exam-ButtonAnsweredMarked" && className != "exam-ButtonAnswered") {
		ChangeClassOFPaletteButton("notans", globCount);
	}
}

function setNavigationPaletteColor(globCount, buttonState) {
	buttonState = buttonState || 0;
	var className = $('#navbtn' + globCount).attr('class');
	if (className != "exam-ButtonNotAnsweredMarked" && className != "exam-ButtonAnsweredMarked" && className != "exam-ButtonAnswered") {
		ChangeClassOFPaletteButton("notans", globCount);
	}
}

function navigation(quesNo) {
	currQuesNo = currentQuesNo();
	globCount = quesNo;
	isNav = true;
	setNavigationPaletteColor(globCount);
	showQuestionPanel(quesNo);
	setPaletteColor(currQuesNo, 1);
	saveAnswerServer(currQuesNo);
}

function callUserAnswerSaveNext(quesNo) {
	setPaletteColor(quesNo, 1);
	if (quesNo > ($('#totalQuestion').text() - 1)) {
		getExamCounter();
		currQuesNo = currentQuesNo();
		attemptTimeServer(quesNo, currQuesNo);
		$.msgBox({
			title: lang['AreYouSure'],
			content: lang['lastQuestion'],
			type: "confirm",
			buttons: [{ value: lang['Yes'] }, { value: lang['No'] }],
			success: function (result) {
				if (result == "Yes") {
					$('.exam-panel').hide();
					$('#quespanel' + $('#startQuestionNo').text()).show();
					$('.exam-SubjectButton').removeClass("exam-subjectHighlight");
					$('#btnSection' + $('#startSectionNo').text()).addClass("exam-subjectHighlight");
				}
			}
		});
	}
	else {
		callNext(quesNo);
	}
	scrollExam();
	saveAnswerServer(quesNo);
}

function scrollExam() {
	// if ($(window).width() < 960) {
	//     $('html, body').animate({scrollTop: '70px'}, 300);
	// }
}

function markForReview(quesNo) {
	globCount = quesNo + 1;
	var className = $('#navbtn' + quesNo).attr('class');
	if (checkAnswer(quesNo)) {
		ChangeClassOFPaletteButton("ansmarked", quesNo);
		saveAnswerServer(quesNo);
		reviewAnswerServer(quesNo);
	}
	else {
		ChangeClassOFPaletteButton("notansmarked", quesNo);
		reviewAnswerServer(quesNo);
	}
	callNext(quesNo);

}

function callPrev(quesNo) {
	if ($('#startQuestionNo').text() != quesNo) {
		quesNo--;
	}
	showQuestionPanel(quesNo);
}

function callNext(quesNo) {
	if ($('#totalQuestion').text() != quesNo) {
		quesNo++;
	}
	globCount = quesNo;
	setPaletteColor(globCount);
	showQuestionPanel(quesNo);
}

function currentQuesNo() {
	currQuesNo = 1;
	$(".exam-panel").each(function () {
		if ($(this).css("display") == "block") {
			currQuesNo = $(this).attr('id').substring(9);
		}
	});
	return currQuesNo;
}

function showQuestionPanel(quesNo) {
	currQuesNo = currentQuesNo();
	$('.exam-panel').hide();
	$('#quespanel' + quesNo).show();
	var className = $('#quespanel' + quesNo).attr('class');
	var lastFive = className.substr(11);
	var lastChar = className.substr(14);
	$('.exam-SubjectButton').removeClass("exam-subjectHighlight");
	$('#btnSection' + lastChar).addClass("exam-subjectHighlight");
	getExamCounter();
	scrollExam();
	attemptTimeServer(quesNo, currQuesNo);
}

function getExamCounter() {
	var answered = 0;
	var notAnswered = 0;
	var notAnswerMarked = 0;
	var notVisited = 0;
	var ansMarked = 0;
	var x = $('#totalQuestion').text();
	var x1 = $('#startQuestionNo').text();
	for (var q = x1; q <= x; q++) {
		var className = $('#navbtn' + q).attr('class');
		if (className == "exam-ButtonAnswered") {
			answered++;
		}
		else if (className == "exam-ButtonNotAnswered") {
			notAnswered++;
		}
		else if (className == "exam-ButtonNotAnsweredMarked") {
			notAnswerMarked++;
		}
		else if (className == "exam-ButtonNotVisited") {
			notVisited++;
		}
		else {
			ansMarked++;
		}
	}
	$("#countAnswered").html(answered);
	$("#countNotAnswered").html(notAnswered);
	$("#countNotAnswerMarked").html(notAnswerMarked);
	$("#countNotVisited").html(notVisited);
	$("#countAnsMarked").html(ansMarked);
}

function ChangeClassOFPaletteButton(c, b) {
	var a = "navbtn" + Count.toString();
	if (typeof b != "undefined") {
		a = "navbtn" + b.toString();
	}
	var d = document.getElementById(a);
	d.attributes.removeNamedItem("class");
	if (c == "notansmarked") {
		d.className += "exam-ButtonNotAnsweredMarked";
	} else {
		if (c == "notans") {
			d.className += "exam-ButtonNotAnswered";
		} else {
			if (c == "ansmarked") {
				d.className += "exam-ButtonAnsweredMarked";
			} else {
				if (c == "ans") {
					d.className += "exam-ButtonAnswered";
				}
			}
		}
	}
}

function FilterPaletteButtons(a) {
	$('#exam-ddlQStatus').val(a);
	if (a == "all") {
		$("#exam-divQuestionPallete button.exam-ButtonNotVisited").css("display", "block");
		$("#exam-divQuestionPallete button.exam-ButtonAnswered").css("display", "block");
		$("#exam-divQuestionPallete button.exam-ButtonAnsweredMarked").css("display", "block");
		$("#exam-divQuestionPallete button.exam-ButtonNotAnswered").css("display", "block");
		$("#exam-divQuestionPallete button.exam-ButtonNotAnsweredMarked").css("display", "block");
		return;
	}
	else {
		$("#exam-divQuestionPallete button.exam-ButtonNotVisited").css("display", "none");
		$("#exam-divQuestionPallete button.exam-ButtonAnswered").css("display", "none");
		$("#exam-divQuestionPallete button.exam-ButtonAnsweredMarked").css("display", "none");
		$("#exam-divQuestionPallete button.exam-ButtonNotAnswered").css("display", "none");
		$("#exam-divQuestionPallete button.exam-ButtonNotAnsweredMarked").css("display", "none");
	}
	if (a == "notansmarked") {
		$("#exam-divQuestionPallete button.exam-ButtonNotAnsweredMarked").css("display", "block");
	}
	else {
		if (a == "notans") {
			$("#exam-divQuestionPallete button.exam-ButtonNotAnswered").css("display", "block");
		}
		else {
			if (a == "ansmarked") {
				$("#exam-divQuestionPallete button.exam-ButtonAnsweredMarked").css("display", "block");
			}
			else {
				if (a == "ans") {
					$("#exam-divQuestionPallete button.exam-ButtonAnswered").css("display", "block");
				}
				else {
					if (a == "notvisit") {
						$("#exam-divQuestionPallete button.exam-ButtonNotVisited").css("display", "block");
					}
				}
			}
		}
	}
}

function SectionButtonClick(sectionId) {
	var idName = $('.subject' + sectionId).attr('id');
	var quesNo = idName.replace("quespanel", "");
	showQuestionPanel(quesNo);
	$('.exam-panel').hide();
	$('.subject' + sectionId).show();
	$('.exam-SubjectButton').removeClass("exam-subjectHighlight");
	$('#btnSection' + sectionId).addClass("exam-subjectHighlight");
}

function changeLang(id, langLength) {
	$('.lang-' + id).show();
	for (i = 1; i <= langLength; i++) {
		if (id != i) {
			$('.lang-' + i).hide();
		}
	}
	$('.examLang').val(id);
}

$(document).ready(function () {
	$("#btnInstructions").click(function () {
		$('#instructionBlock').show();
		$("#instructionBlock").addClass("exam-overlay").removeClass("hidden");
		return false;
	});

	$("#btnProfile").click(function () {
		$('#userInfo').show();
		$("#userInfo").addClass("exam-overlay").removeClass("hidden");
		return false;
	});
	$("#btnQuestionPaper").click(function () {
		$('#QuestionPaperBlock').show();
		$("#QuestionPaperBlock").addClass("exam-overlay").removeClass("hidden");
		return false;
	});
	$("#instructionBack").click(function () {
		$("#instructionBlock").addClass("hidden").removeClass("exam-overlay");
		return false;
	});
	$("#userinfoBack").click(function () {
		$("#userInfo").addClass("hidden").removeClass("exam-overlay");
		return false;
	});
	$("#questionPaperBack").click(function () {
		$("#QuestionPaperBlock").addClass("hidden").removeClass("exam-overlay");
		return false;
	});
	$("#instructionBlock").addClass("hidden").removeClass("exam-overlay");
	$("#userInfo").addClass("hidden").removeClass("exam-overlay");
	$("#QuestionPaperBlock").addClass("hidden").removeClass("exam-overlay");

});

function saveAnswerServer(quesNo) {
	$(document).ready(function () {
		var examUrl = $('#examUrl').text();
		var saveUrl = $('#saveUrl').text() + '/' + quesNo;
		$.ajax({
			type: "POST",
			data: $('#post_req-' + quesNo).serialize(),
			url: saveUrl,
		})
			.done(function (data) {
				if (data == false) {
					window.location = examUrl;
				}

			})
			.error(function (xhr, textStatus, errorThrown) {
				retryAjax();
			});
	});
}

function resetAnswerServer(quesNo) {
	$(document).ready(function () {
		var resetUrl = $('#resetUrl').text() + '/' + quesNo;
		$.ajax({
			type: "GET",
			url: resetUrl,
		})
			.done(function (data) {

			})
			.error(function (xhr, textStatus, errorThrown) {
				retryAjax();
			});
	});
}

function reviewAnswerServer(quesNo) {
	$(document).ready(function () {
		var reviewUrl = $('#reviewAnswerUrl').text() + '/' + quesNo;
		$.ajax({
			type: "GET",
			url: reviewUrl,
		})
			.done(function (data) {

			})
			.error(function (xhr, textStatus, errorThrown) {
				retryAjax();
			});
	});
}

function attemptTimeServer(quesNo, currQuesNo) {
	$(document).ready(function () {
		var attemptTimeUrl = $('#attemptTimeUrl').text() + '/' + quesNo + '/' + currQuesNo;
		$.ajax({
			type: "GET",
			url: attemptTimeUrl,
		})
			.done(function (data) {

			})
			.error(function (xhr, textStatus, errorThrown) {
				retryAjax();
			});
	});
}

function retryAjax(xhr, textStatus, errorThrown) {
	examUrl = $('#examUrl').text();
	tryCount = 0;
	retryLimit = 3;
	if (textStatus == 'timeout') {
		tryCount++;
		if (tryCount <= retryLimit) {
			$.ajax(this);
			return;
		}
		return;
	}
	if (xhr.status == 500) {
		window.location = examUrl;
	}
	else {
		window.location = examUrl;
	}
}

document.onkeydown = function (e) {
	e = e || window.event;//Get event
	if (e.ctrlKey) {
		var c = e.which || e.keyCode;//Get key code
		switch (c) {
			case 83://Block Ctrl+S
			case 87://Block Ctrl+W --Not work in Chrome
			case 85://Block Ctrl+U
			case 65://Block Ctrl+A
			case 67://Block Ctrl+C
			case 88://Block Ctrl+X
			case 86://Block Ctrl+V
			case 80://Block Ctrl+P
			case 73://Block Cltr+Shift+I
			case 67://Block Cltr+Shift+C
			case 75://Block Cltr+Shift+K
			case 81://Block Cltr+Shift+Q
				e.preventDefault();
				e.stopPropagation();
				break;
		}
		if (c == 80) {
			if (navigator.userAgent.match(/msie/i) || navigator.userAgent.match(/trident/i)) {
				alert("You can not print");
			}
		}
	}
	if (e.shiftKey) {
		var c = e.which || e.keyCode;//Get key code
		switch (c) {
			case 116://Block Shift+F5
			case 118://Block Shift+F7
				e.preventDefault();
				e.stopPropagation();
				break;
		}
	}
	var c = e.keyCode;
	switch (c) {
		case 123://Block F12
			e.preventDefault();
			e.stopPropagation();
			break;
	}
};

function firstNavigation(quesNo) {
	globCount = quesNo;
	isNav = true;
	setPaletteColor(globCount);
	currQuesNo = currentQuesNo();
	$('.exam-panel').hide();
	$('#quespanel' + quesNo).show();
	var className = $('#quespanel' + quesNo).attr('class');
	var lastFive = className.substr(15);
	var lastChar = className.substr(18);
	$('.exam-SubjectButton').removeClass("exam-subjectHighlight");
	$('#btnSection' + lastChar).addClass("exam-subjectHighlight");
	getExamCounter();
	scrollExam();
}
function nextNavigation(quesNo) {
	globCount = quesNo;
	isNav = true;
	setPaletteColor(globCount);
	currQuesNo = currentQuesNo();
	$('.exam-panel').hide();
	$('#quespanel' + quesNo).show();
	var className = $('#quespanel' + quesNo).attr('class');
	var lastFive = className.substr(15);
	var lastChar = className.substr(18);
	$('.exam-SubjectButton').removeClass("exam-subjectHighlight");
	$('#btnSection' + lastChar).addClass("exam-subjectHighlight");
	getExamCounter();
	scrollExam();
}
